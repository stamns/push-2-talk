name: Release Pipeline

on:
  push:
    branches:
      - main        # ç›‘å¬ main åˆ†æ”¯çš„æ™®é€šæäº¤ï¼ˆåªæµ‹è¯•æ„å»ºï¼‰
    tags:
      - 'v*'        # ç›‘å¬æ‰“æ ‡ç­¾ï¼ˆæ‰§è¡Œå‘å¸ƒï¼‰
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  # ========================================================
  # Job 1: æ„å»ºæµ‹è¯• (Build Test)
  # åœºæ™¯: åªæ˜¯ Push ä»£ç åˆ° main åˆ†æ”¯ï¼Œæ²¡æœ‰æ‰“ Tag
  # ç›®çš„: ç¡®ä¿ä»£ç èƒ½ç¼–è¯‘é€šè¿‡ï¼Œä½†ä¸æ¶ˆè€—ç‰ˆæœ¬å·ï¼Œä¸å‘å¸ƒ
  # ========================================================
  test-build:
    # å¦‚æœä¸æ˜¯ Tagï¼Œä¸”ä¸æ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™è¿è¡Œæµ‹è¯•
    if: startsWith(github.ref, 'refs/tags/') != true
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build only (No Release)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: dW50cnVzdGVkIGNvbW1lbnQ6IHJzaWduIGVuY3J5cHRlZCBzZWNyZXQga2V5ClJXUlRZMEl5UW5Nb3ZvRnFVL25mNmRRQ2FDZE9rRzlYaHhEWkxOQ0x2OERRL09aTm9BWUFBQkFBQUFBQUFBQUFBQUlBQUFBQUsydjdtdkdpVWQ4dTcxS1Z4K0F0Q3VCQXZ3K01BcnhvUThTLzZ1NGlQbkxpK1dUYVZUbndCTG5LaE9ZQ0JvY0FlYTk1aDB0TkxHc3FFVDBnOS8zL3dFWTRndHNUUzlVbG12LzVNSFpscG4yTkZhWk5ZbUxwMUdLNlE5NVFXR09qa09DcUd5ZVBMeHM9Cg==
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        run: npm run tauri build

  # ========================================================
  # Job 2: æ­£å¼å‘å¸ƒ (Release)
  # åœºæ™¯: æ¨é€äº† v* æ ‡ç­¾
  # ç›®çš„: ç”Ÿæˆæ›´æ–°æ—¥å¿—ã€ç­¾åã€æ‰“åŒ…ã€ä¸Šä¼  Release
  # ========================================================
  release:
    # åªæœ‰å½“æ¨é€çš„æ˜¯ Tag æ—¶æ‰è¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          # è·å–å½“å‰ tag
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "Current tag: $CURRENT_TAG"

          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"

          # è·å– commit åˆ—è¡¨
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" -50)
          else
            COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"%s")
          fi

          # åˆ†ç±» commits
          FEATURES=""
          FIXES=""
          UPDATES=""
          OTHERS=""

          while IFS= read -r line; do
            [ -z "$line" ] && continue

            if echo "$line" | grep -qiE "^feat[ï¼š:]"; then
              FEATURES="${FEATURES}- ${line#*[ï¼š:]}"$'\n'
            elif echo "$line" | grep -qiE "^(fix|bugfix|bug)[ï¼š:]"; then
              FIXES="${FIXES}- ${line#*[ï¼š:]}"$'\n'
            elif echo "$line" | grep -qiE "^(update|improve|perf|ä¼˜åŒ–)[ï¼š:]"; then
              UPDATES="${UPDATES}- ${line#*[ï¼š:]}"$'\n'
            elif echo "$line" | grep -qiE "^(chore|docs|refactor|style|test|security)[ï¼š:]"; then
              OTHERS="${OTHERS}- ${line#*[ï¼š:]}"$'\n'
            else
              OTHERS="${OTHERS}- ${line}"$'\n'
            fi
          done <<< "$COMMITS"

          # æ„å»º changelog
          CHANGELOG=""

          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}## âœ¨ æ–°åŠŸèƒ½"$'\n'"${FEATURES}"$'\n'
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}## ğŸ› Bug ä¿®å¤"$'\n'"${FIXES}"$'\n'
          fi

          if [ -n "$UPDATES" ]; then
            CHANGELOG="${CHANGELOG}## ğŸš€ ä¼˜åŒ–æ”¹è¿›"$'\n'"${UPDATES}"$'\n'
          fi

          if [ -n "$OTHERS" ]; then
            CHANGELOG="${CHANGELOG}## ğŸ“¦ å…¶ä»–"$'\n'"${OTHERS}"$'\n'
          fi

          # å¦‚æœæ²¡æœ‰ä»»ä½•åˆ†ç±»çš„ commits
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="æœ¬æ¬¡æ›´æ–°æ— é‡å¤§å˜æ›´"$'\n'
          fi

          # è¾“å‡ºåˆ° GitHub Actions
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: dW50cnVzdGVkIGNvbW1lbnQ6IHJzaWduIGVuY3J5cHRlZCBzZWNyZXQga2V5ClJXUlRZMEl5UW5Nb3ZvRnFVL25mNmRRQ2FDZE9rRzlYaHhEWkxOQ0x2OERRL09aTm9BWUFBQkFBQUFBQUFBQUFBQUlBQUFBQUsydjdtdkdpVWQ4dTcxS1Z4K0F0Q3VCQXZ3K01BcnhvUThTLzZ1NGlQbkxpK1dUYVZUbndCTG5LaE9ZQ0JvY0FlYTk1aDB0TkxHc3FFVDBnOS8zL3dFWTRndHNUUzlVbG12LzVNSFpscG4yTkZhWk5ZbUxwMUdLNlE5NVFXR09qa09DcUd5ZVBMeHM9Cg==
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        with:
          tagName: v__VERSION__
          releaseName: 'v__VERSION__'
          releaseBody: |
            ${{ steps.changelog.outputs.changelog }}

            ## ä¸‹è½½å®‰è£…
            - **Windows**: ä¸‹è½½ `.exe` å®‰è£…åŒ…
            - å®‰è£…åéœ€ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
            - åº”ç”¨å†…æ”¯æŒè‡ªåŠ¨æ›´æ–°

            ---
            è‡ªåŠ¨æ„å»º by GitHub Actions
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
          args: ${{ matrix.args }}
